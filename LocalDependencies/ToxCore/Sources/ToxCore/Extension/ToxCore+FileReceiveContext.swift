//
//  ToxCore+FileReceiveContext.swift
//
//
//  Created by Vitalii Sosin on 10.06.2024.
//

import Foundation
import ToxCoreCpp

// –ö–ª–∞—Å—Å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –ø—Ä–∏–µ–º–µ —Ñ–∞–π–ª–æ–≤
/// –ö–ª–∞—Å—Å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±—Ä–∞—Ç–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ –ø—Ä–∏ –ø—Ä–∏–µ–º–µ —Ñ–∞–π–ª–æ–≤.
/// - `callback`: –ó–∞–º—ã–∫–∞–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω–æ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞.
/// - `init(callback:)`: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ–±—ä–µ–∫—Ç —Å –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–º –∑–∞–º—ã–∫–∞–Ω–∏–µ–º.
final class FileReceiveContext {
  var callback: (Int32, Int32, String, UInt64) -> Void
  
  /// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ–±—ä–µ–∫—Ç `FileReceiveContext` —Å –∑–∞–¥–∞–Ω–Ω—ã–º –∑–∞–º—ã–∫–∞–Ω–∏–µ–º.
  /// - Parameter callback: –ó–∞–º—ã–∫–∞–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω–æ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞. –ó–∞–º—ã–∫–∞–Ω–∏–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
  ///   - `friendId`: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥—Ä—É–≥–∞, –æ—Ç –∫–æ—Ç–æ—Ä–æ–≥–æ –ø–æ—Å—Ç—É–ø–∏–ª —Ñ–∞–π–ª.
  ///   - `fileId`: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ñ–∞–π–ª–∞.
  ///   - `fileName`: –ò–º—è —Ñ–∞–π–ª–∞.
  ///   - `fileSize`: –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –≤ –±–∞–π—Ç–∞—Ö.
  init(callback: @escaping (Int32, Int32, String, UInt64) -> Void) {
    self.callback = callback
  }
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
var globalConnectionFileReceiveContext: FileReceiveContext?

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
/// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –æ—Ç –¥—Ä—É–∑–µ–π –≤ —Å–µ—Ç–∏ Tox.
/// –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≤ Tox –∫–∞–∫ –∫–æ–ª–ª–±–µ–∫ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–∞–π–ª–∞.
/// - Parameters:
///   - tox: –£–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —Ç–µ–∫—É—â–∏–π –æ–±—ä–µ–∫—Ç Tox.
///   - friendId: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥—Ä—É–≥–∞, –æ—Ç–ø—Ä–∞–≤–∏–≤—à–µ–≥–æ —Ñ–∞–π–ª.
///   - fileId: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ñ–∞–π–ª–∞.
///   - kind: –¢–∏–ø —Ñ–∞–π–ª–∞ (–æ–±—ã—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –∞–≤–∞—Ç–∞—Ä, –∏ —Ç.–¥.).
///   - fileSize: –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –≤ –±–∞–π—Ç–∞—Ö.
///   - fileName: –£–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –±–∞–π—Ç—ã –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞. –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ nil, –∏–º—è —Ñ–∞–π–ª–∞ –Ω–µ –±—ã–ª–æ –ø–æ–ª—É—á–µ–Ω–æ.
///   - fileNameLength: –î–ª–∏–Ω–∞ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –≤ –±–∞–π—Ç–∞—Ö.
///   - userData: –£–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –≤–º–µ—Å—Ç–µ —Å –∫–æ–ª–ª–±–µ–∫–æ–º.
let fileReceiveCallback: @convention(c) (
  UnsafeMutablePointer<Tox>?,
  UInt32,
  UInt32,
  UInt32,
  UInt64,
  UnsafePointer<UInt8>?,
  Int,
  UnsafeMutableRawPointer?
) -> Void = { tox, friendId, fileId, kind, fileSize, fileName, fileNameLength, userData in
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –∏–º—è —Ñ–∞–π–ª–∞ –Ω–µ —Ä–∞–≤–µ–Ω nil –∏ –¥–ª–∏–Ω–∞ –∏–º–µ–Ω–∏ –±–æ–ª—å—à–µ –Ω—É–ª—è
  guard let fileName, fileNameLength > 0 else { return }
  
  // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
  guard let context = globalConnectionFileReceiveContext else {
    print("üî¥ –û—à–∏–±–∫–∞: –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    return
  }
  
  // –°–æ–∑–¥–∞–µ–º Data –∏–∑ —É–∫–∞–∑–∞—Ç–µ–ª—è –Ω–∞ –±–∞–π—Ç—ã –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
  let fileNameData = Data(bytes: fileName, count: Int(fileNameLength))
  
  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Data –≤ —Å—Ç—Ä–æ–∫—É –∏ –≤—ã–∑—ã–≤–∞–µ–º –∑–∞–º—ã–∫–∞–Ω–∏–µ —Å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞–º–∏ –¥—Ä—É–≥–∞ –∏ —Ñ–∞–π–ª–∞, –∏–º–µ–Ω–µ–º —Ñ–∞–π–ª–∞ –∏ —Ä–∞–∑–º–µ—Ä–æ–º —Ñ–∞–π–ª–∞
  if let fileNameStr = String(data: fileNameData, encoding: .utf8) {
    context.callback(Int32(friendId), Int32(fileId), fileNameStr, fileSize)
  }
}
